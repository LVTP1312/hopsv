--// Steal-a-Brainrot server hop (phím H)
--// PlaceId: 109983668079237

local PLACE_ID = 109983668079237

-- CẤU HÌNH
local MIN_PLAYERS       = 2     -- server ít nhất bao nhiêu người
local MAX_PLAYERS       = 6     -- server tối đa bao nhiêu người
local MAX_SERVER_PAGES  = 8     -- tối đa số trang server API duyệt
local MIN_FREE_SLOTS    = 2     -- tối thiểu slot trống
local MAX_HOP_RETRIES   = 5     -- tối đa số lần tự hop lại khi 772

local Players         = game:GetService("Players")
local LocalPlayer     = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")
local HttpService     = game:GetService("HttpService")
local UIS             = game:GetService("UserInputService")

-- STATE
getgenv().SB_VisitedServers = getgenv().SB_VisitedServers or {}
local visited = getgenv().SB_VisitedServers
visited[game.JobId] = true

getgenv().SB_IsHopping  = false
getgenv().SB_HopRetries = 0

---------------------------------------------------------------------local function GetServers(cursor)
    local url = "https://games.roblox.com/v1/games/" .. PLACE_ID .. "/servers/Public?sortOrder=Asc&limit=100"
    if cursor then
        url ..= "&cursor=" .. cursor
    end

    local suc, res = pcall(function()
        return game:HttpGet(url)
    end)
    if not suc then
        warn("[SB Hop] Lỗi lấy server list:", res)
        return nil
    end

    local ok, data = pcall(function()
        return HttpService:JSONDecode(res)
    end)
    if not ok then
        warn("[SB Hop] Lỗi decode JSON:", data)
        return nil
    end

    return data
end

-- Chọn 1 server phù hợp:
--  - Không trùng JobId hiện tại
--  - Không nằm trong visited
--  - Số người trong [MIN_PLAYERS, MAX_PLAYERS]
--  - Còn >= MIN_FREE_SLOTS slot trống
--  - Random trong list phù hợp (1 acc thôi)
local function PickBestServer()
    local goodServers = {}
    local cursor, pageCount = nil, 0

    while pageCount < MAX_SERVER_PAGES do
        local data = GetServers(cursor)
        if not data or not data.data then break end

        for _, server in ipairs(data.data) do
            local jobId     = server.id
            local playing   = tonumber(server.playing) or 0
            local maxPlayer = tonumber(server.maxPlayers) or 0
            local freeSlots = maxPlayer - playing

            if jobId
                and jobId ~= game.JobId
                and not visited[jobId]
                and playing >= MIN_PLAYERS
                and playing <= MAX_PLAYERS
                and freeSlots >= MIN_FREE_SLOTS
            then
                table.insert(goodServers, server)
            end
        end

        if #goodServers > 0 then
            break
        end

        cursor = data.nextPageCursor
        if not cursor then break end
        pageCount += 1
        task.wait(0.1)
    end

    if #goodServers == 0 then
        return nil
    end

    return goodServers[math.random(1, #goodServers)]
end

local function StartHop(isRetry)
    if getgenv().SB_IsHopping then
        warn("[SB Hop] Đang hop rồi, chờ tí...")
        return
    end

    if not isRetry then
        getgenv().SB_HopRetries = 0
    end

    getgenv().SB_IsHopping = true

    print(string.format(
        "[SB Hop] Tìm server (min: %d, max: %d người, ≥%d slot trống)...",
        MIN_PLAYERS, MAX_PLAYERS, MIN_FREE_SLOTS
    ))

    local target = PickBestServer()
    if not target then
        warn("[SB Hop] Không tìm được server phù hợp.")
        getgenv().SB_IsHopping = false
        return
    end

    local jobId     = target.id
    local playing   = tonumber(target.playing) or 0
    local maxPlayer = tonumber(target.maxPlayers) or 0
    local freeSlots = maxPlayer - playing

    visited[jobId] = true -- dù fail cũng coi như đã thử, tránh quay lại

    print(("[SB Hop] Teleport tới: %s | %d/%d (trống: %d)")
        :format(jobId, playing, maxPlayer, freeSlots))

    local suc, err = pcall(function()
        TeleportService:TeleportToPlaceInstance(PLACE_ID, jobId, LocalPlayer)
    end)
    if not suc then
        warn("[SB Hop] Lỗi gọi Teleport:", err)
        getgenv().SB_IsHopping = false
    end
end

----------------------------------------------------------------------- Bắt event khi teleport fail (ví dụ 772 – GameFull)
TeleportService.TeleportInitFailed:Connect(function(player, teleportResult, errorMessage)
    if player ~= LocalPlayer then return end

    local msg = tostring(errorMessage or "")
    warn("[SB Hop] TeleportInitFailed:", teleportResult, msg)

    -- luôn reset flag để không bị kẹt "Đang hop rồi"
    getgenv().SB_IsHopping = false

    local isFull =
        string.find(msg, "772") ~= nil or
        string.find(string.lower(msg), "full") ~= nil

    if isFull then
        if getgenv().SB_HopRetries < MAX_HOP_RETRIES then
            getgenv().SB_HopRetries += 1
            warn("[SB Hop] Server full (772), thử server khác... Lần:", getgenv().SB_HopRetries)
            task.delay(1.5, function()
                StartHop(true)
            end)
        else
            warn("[SB Hop] Đã thử lại nhiều lần mà vẫn full, dừng.")
        end
    end
end)

----------------------------------------------------------------------- Bind phím H để hop
UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.H then
        StartHop(false)
    end
end)

print(("[SB Hop] Load xong. Bấm H để hop (ưu tiên %d–%d người, ≥%d slot trống, auto retry khi full).")
    :format(MIN_PLAYERS, MAX_PLAYERS, MIN_FREE_SLOTS))
