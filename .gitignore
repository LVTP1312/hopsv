--// Steal-a-Brainrot server hop (auto sau 10s + ph√≠m H, retry 5s)
--// PlaceId: 109983668079237

local PLACE_ID = 109983668079237

-- C·∫§U H√åNH
local MIN_PLAYERS       = 0    -- server √≠t nh·∫•t bao nhi√™u ng∆∞·ªùi
local MAX_PLAYERS       = 7    -- server t·ªëi ƒëa bao nhi√™u ng∆∞·ªùi
local MAX_SERVER_PAGES  = 8    -- t·ªëi ƒëa s·ªë trang server API duy·ªát
local MIN_FREE_SLOTS    = 2    -- t·ªëi thi·ªÉu slot tr·ªëng

-- D·ªäCH V·ª§
local Players         = game:GetService("Players")
local LocalPlayer     = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")
local HttpService     = game:GetService("HttpService")
local UIS             = game:GetService("UserInputService")

-- L∆∞u server ƒë√£ v√†o (JobId) ƒë·ªÉ kh√¥ng join l·∫°i
getgenv().SB_VisitedServers = getgenv().SB_VisitedServers or {}
local visited = getgenv().SB_VisitedServers
visited[game.JobId] = true

-- Flag ch·ªëng spam hop
getgenv().SB_IsHopping = false

-- H√†m l·∫•y list server t·ª´ Roblox API
local function GetServers(cursor)
    local url = "https://games.roblox.com/v1/games/" .. tostring(PLACE_ID) .. "/servers/Public?sortOrder=Asc&limit=100"
    if cursor then
        url = url .. "&cursor=" .. cursor
    end

    local success, res = pcall(function()
        return game:HttpGet(url)
    end)
    if not success then
        warn("[SB Hop] Loi HttpGet: ", res)
        return nil
    end

    local ok, data = pcall(function()
        return HttpService:JSONDecode(res)
    end)
    if not ok then
        warn("[SB Hop] Loi JSONDecode: ", data)
        return nil
    end

    return data
end

-- H√†m ch·ªçn server t·ªët nh·∫•t (co fallback)
local function PickBestServer()
    local goodServers = {}     -- server dung range (uu tien)
    local fallbackServers = {} -- server fallback: chi can con slot trong, khac JobId

    local cursor = nil
    local pageCount = 0
    local totalChecked = 0

    while pageCount < MAX_SERVER_PAGES do
        local data = GetServers(cursor)
        if not data or not data.data then
            break
        end

        for _, server in ipairs(data.data) do
            local jobId     = server.id
            local playing   = tonumber(server.playing) or 0
            local maxPlayer = tonumber(server.maxPlayers) or 0
            local freeSlots = maxPlayer - playing

            totalChecked = totalChecked + 1

            if jobId and jobId ~= game.JobId and not visited[jobId] and freeSlots >= 1 then
                -- Server dung range minh muon
                if playing >= MIN_PLAYERS and playing <= MAX_PLAYERS and freeSlots >= MIN_FREE_SLOTS then
                    table.insert(goodServers, server)
                else
                    -- Khong dung range nhung van con slot -> fallback
                    table.insert(fallbackServers, server)
                end
            end
        end

        if #goodServers > 0 then
            break
        end

        cursor = data.nextPageCursor
        if not cursor then
            break
        end

        pageCount = pageCount + 1
        task.wait(0.1)
    end

    print(string.format(
        "[SB Hop] Da duyet %d server, page = %d",
        totalChecked,
        pageCount + 1
    ))

    if #goodServers > 0 then
        print("[SB Hop] Tim duoc server dung range, dang chon random...")
        return goodServers[math.random(1, #goodServers)]
    end

    if #fallbackServers > 0 then
        warn("[SB Hop] Khong co server nam trong range, dung server fallback (chi can con slot).")
        return fallbackServers[math.random(1, #fallbackServers)]
    end

    return nil
end

-- H√†m teleport v·ªõi retry 5s/l·∫ßn cho ƒë·∫øn khi sang server m·ªõi
local function TeleportWithRetry(placeId, jobId, retryDelay)
    retryDelay = retryDelay or 5
    local startJobId = game.JobId
    local attempt = 0

    while game.JobId == startJobId do
        attempt = attempt + 1
        print(("[SB Hop] Thu teleport lan %d..."):format(attempt))

        local success, err = pcall(function()
            TeleportService:TeleportToPlaceInstance(placeId, jobId, LocalPlayer)
        end)

        if not success then
            warn("[SB Hop] Loi teleport lan " .. attempt .. ": " .. tostring(err))
        end

        -- ch·ªù t·ªëi ƒëa retryDelay gi√¢y, n·∫øu JobId ƒë·ªïi th√¨ coi nh∆∞ tp th√†nh c√¥ng
        local elapsed = 0
        while elapsed < retryDelay do
            task.wait(0.1)
            elapsed = elapsed + 0.1
            if game.JobId ~= startJobId then
                print("[SB Hop] Da sang server moi sau " .. attempt .. " lan thu.")
                return true
            end
        end

        -- n·∫øu t·ªõi ƒë√¢y m√† JobId v·∫´n ch∆∞a ƒë·ªïi th√¨ loop ti·∫øp, g·ªçi tp l·∫°i
        print("[SB Hop] Van o server cu sau " .. retryDelay .. "s, thu tp lai...")
    end

    return false
end

-- H√†m hop server
local function HopServer()
    if getgenv().SB_IsHopping then
        warn("[SB Hop] Dang hop roi, cho ti...")
        return
    end
    getgenv().SB_IsHopping = true

    print(string.format(
        "[SB Hop] Tim server (min: %d, max: %d nguoi, >=%d slot trong)...",
        MIN_PLAYERS, MAX_PLAYERS, MIN_FREE_SLOTS
    ))

    local target = PickBestServer()
    if not target then
        warn("[SB Hop] Khong tim duoc server phu hop.")
        getgenv().SB_IsHopping = false
        return
    end

    local jobId     = target.id
    local playing   = tonumber(target.playing) or 0
    local maxPlayer = tonumber(target.maxPlayers) or 0
    local freeSlots = maxPlayer - playing

    visited[jobId] = true

    print(("[SB Hop] Muc tieu: %s | %d/%d (trong: %d)")
        :format(jobId, playing, maxPlayer, freeSlots))

    -- ‚òÖ g·ªçi teleport + retry 5s/l·∫ßn
    TeleportWithRetry(PLACE_ID, jobId, 5)

    -- n·∫øu t·ªõi ƒë√¢y m√† v·∫´n ch∆∞a sang server m·ªõi (Teleport fail ho√†i) th√¨ m·ªü l·∫°i flag
    if game.JobId == game.JobId then
        getgenv().SB_IsHopping = false
    end
end

-- üîπ Auto hop sau 10 gi√¢y khi execute script
task.spawn(function()
    task.wait(10) -- auto sau 10s
    HopServer()
end)

-- Bind phim H de hop l·∫°i (neu muon)
UIS.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then
        return
    end
    if input.KeyCode == Enum.KeyCode.H then
        HopServer()
    end
end)

print(("[SB Hop] Load xong. Se auto hop sau 10s. Nhan H de hop lai (uu tien %d-%d nguoi, >=%d slot trong, retry 5s).")
    :format(MIN_PLAYERS, MAX_PLAYERS, MIN_FREE_SLOTS))
