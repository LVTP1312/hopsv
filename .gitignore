--// Steal-a-Brainrot server hop (phím H)
--// PlaceId: 109983668079237

local PLACE_ID = 109983668079237

-- CẤU HÌNH
local MIN_PLAYERS    = 2   -- server ít nhất bao nhiêu người
local MAX_PLAYERS    = 6   -- server tối đa bao nhiêu người
local MIN_FREE_SLOTS = 2   -- tối thiểu slot trống (1 acc thì 2 là đủ)

local Players         = game:GetService("Players")
local LocalPlayer     = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")
local HttpService     = game:GetService("HttpService")
local UIS             = game:GetService("UserInputService")

-- STATE dùng chung
getgenv().SB_VisitedServers   = getgenv().SB_VisitedServers or {}
getgenv().SB_IsHopping        = getgenv().SB_IsHopping or false

local visited = getgenv().SB_VisitedServers
visited[game.JobId] = true

---------------------------------------------------------------------local function GetServersOnce()
    -- CHỈ GỌI 1 LẦN, LẤY PAGE ĐẦU 100 SERVER
    local url = "https://games.roblox.com/v1/games/" .. PLACE_ID .. "/servers/Public?sortOrder=Asc&limit=100"

    local suc, res = pcall(function()
        return game:HttpGet(url)
    end)

    if not suc then
        local msg = tostring(res)
        if string.find(msg, "429") or string.find(string.lower(msg), "too many requests") then
            warn("[SB Hop] Roblox chặn lấy list server (HTTP 429: Too Many Requests).")
        else
            warn("[SB Hop] Lỗi lấy server list:", msg)
        end
        return nil
    end

    local ok, data = pcall(function()
        return HttpService:JSONDecode(res)
    end)
    if not ok then
        warn("[SB Hop] Lỗi decode JSON:", data)
        return nil
    end

    return data
end

local function PickBestServerFast()
    local data = GetServersOnce()
    if not data or not data.data then
        return nil
    end

    local candidates = {}

    for _, server in ipairs(data.data) do
        local jobId     = server.id
        local playing   = tonumber(server.playing) or 0
        local maxPlayer = tonumber(server.maxPlayers) or 0
        local freeSlots = maxPlayer - playing

        if jobId
            and jobId ~= game.JobId
            and not visited[jobId]
            and playing >= MIN_PLAYERS
            and playing <= MAX_PLAYERS
            and freeSlots >= MIN_FREE_SLOTS
        then
            table.insert(candidates, server)
        end
    end

    if #candidates == 0 then
        return nil
    end

    -- random 1 server trong số 100 server mới nhất đó
    return candidates[math.random(1, #candidates)]
end

local function HopServer()
    if getgenv().SB_IsHopping then
        warn("[SB Hop] Đang hop rồi, chờ tí...")
        return
    end
    getgenv().SB_IsHopping = true

    print(string.format(
        "[SB Hop] Tìm server (min: %d, max: %d người, ≥%d slot trống, quét 1 page)...",
        MIN_PLAYERS, MAX_PLAYERS, MIN_FREE_SLOTS
    ))

    local target = PickBestServerFast()
    if not target then
        warn("[SB Hop] Không tìm được server phù hợp trong 100 server gần nhất.")
        getgenv().SB_IsHopping = false
        return
    end

    local jobId     = target.id
    local playing   = tonumber(target.playing) or 0
    local maxPlayer = tonumber(target.maxPlayers) or 0
    local freeSlots = maxPlayer - playing

    visited[jobId] = true

    print(("[SB Hop] Teleport tới: %s | %d/%d (trống: %d)")
        :format(jobId, playing, maxPlayer, freeSlots))

    local suc, err = pcall(function()
        TeleportService:TeleportToPlaceInstance(PLACE_ID, jobId, LocalPlayer)
    end)
    if not suc then
        warn("[SB Hop] Lỗi teleport:", err)
        getgenv().SB_IsHopping = false
    end
end

-- reset flag khi teleport fail (772, v.v.)
if not getgenv().SB_TeleportConn then
    getgenv().SB_TeleportConn = TeleportService.TeleportInitFailed:Connect(function(player, teleportResult, errorMessage)
        if player ~= LocalPlayer then return end
        warn("[SB Hop] Teleport fail:", teleportResult, tostring(errorMessage or ""))
        getgenv().SB_IsHopping = false
    end)
end

-- bind phím H, chỉ bind 1 lần
if not getgenv().SB_InputConn then
    getgenv().SB_InputConn = UIS.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if input.KeyCode == Enum.KeyCode.H then
            HopServer()
        end
    end)
end

print(("[SB Hop] Load xong. Bấm H để hop (ưu tiên %d–%d người, ≥%d slot trống, 1 request là xong).")
    :format(MIN_PLAYERS, MAX_PLAYERS, MIN_FREE_SLOTS))
